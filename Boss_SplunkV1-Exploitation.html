<!DOCTYPE HTML>
<html>

<head>
  <title>Massively by HTML5 UP</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <noscript>
    <link rel="stylesheet" href="assets/css/noscript.css" />
  </noscript>
</head>

<body class="is-preload">

  <!-- Wrapper -->
  <div id="wrapper" class="fade-in">

    <!-- Intro -->
    <div id="intro">
      <h2>Incident Handling with Splunk<br /></h2>
      <a>Exploitation Phase</a></h1>
      <p>Miguel Nogueira</p>
      <ul class="actions">
        <li><a href="#main" class="button icon solid solo fa-arrow-down scrolly">Continue</a></li>
      </ul>
    </div>


    <div id="copyright">
      <ul>
        <li>
          <h6><a href="index.html">Home Page</h6>
          </a>
        </li>
        <li>
          <h6><a href="CTFS.html">Previous ‎ ‎ ‎</h6>
          </a>
        </li>

      </ul>
    </div>






    <!-- Main -->
    <div id="main">


      <!-- Post -->
      <section class="post"><strong><strong>
            The attacker needs to exploit the vulnerability to gain access to the
            system/server.<br />In this task, we will look at the potential exploitation attempt from the attacker
            against
            our
            web server and see if the attacker got successful in exploiting or not.<br /><br />
            <h3>To begin our investigation, let&#39;s note the information we have so far:</h3><br />• We found two IP
            addresses
            from the reconnaissance phase with sending requests to our server.• One of the
            IPs <strong>40.80.148.42</strong> was seen attempting to scan the server with
            IP <strong>192.168.250.70</strong>.<br />• The attacker was using the web scanner Acunetix for the scanning
            attempt.<br /><strong>
            </strong><br />Let&#39;s use the following search query to see the number of counts by each source IP
            against
            the
            webserver.<br /><br /><strong>
              <h3>Search Query:</h3>

              <div class="codebox">
                <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 imreallynotbatman.com sourcetype=stream* <span style="color:#ff9d00;font-weight:700">|</span> stats count<span style="color:#ff9d00;font-weight:700">(</span>src_ip<span style="color:#ff9d00;font-weight:700">)</span><br> as Requests by src_ip <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">sort</span> - Requests</pre>
              </div><a href=""><span class="image fit"><img src="images/53-1.png"
                    alt="images/53-1.png" /></a>Additionally,
              we
              can
              also create different visualization to show the result. Click on <strong>Visualization → Select
                Visualization</strong> as shown below.<br /><br /><a href=""><span class="image fit"><img
                    src="images/53-2.png" alt="images/53-2.png" /></a><br /><br />Now we will narrow down the result to
              show requests sent to
              our
              web
              server, which has the IP <strong>192.168.250.70</strong><br /><br /><strong>
                <h3>Search Query:</h3>

                <div class="codebox">
                  <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 sourcetype=stream<span style="color:#ff9d00;font-weight:700">:</span>http dest_ip=<span style="color:#3ad900;font-weight:400">&quot;192.168.250.70&quot;</span></pre>
                </div><a href=""><span class="image fit"><img src="images/53-3.png" alt="images/53-3.png" /></a>The
                result
                in
                the <strong>src_ip</strong> field shows three IP addresses (1 local IP and two remote IPs) that
                originated
                the HTTP traffic towards our webserver.<br /><br />Another interesting
                field, <strong>http_method</strong> will
                give
                us information about the HTTP Methods observed during these HTTP communications.<br /><br />We observed
                most
                of
                the
                requests coming to our server through the POST request, as shown below.<br /><a href=""><span
                    class="image fit"><img src="images/53-4.png" alt="images/53-4.png" /></a><br /><br />To see what
                kind
                of traffic is coming
                through the POST requests, we
                will
                narrow down on the field <strong>http_method=POST</strong> as shown below:
                <h3>Search Query:</h3>

                <div class="codebox">
                  <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 sourcetype=stream<span style="color:#ff9d00;font-weight:700">:</span>http dest_ip=<span style="color:#3ad900;font-weight:400">&quot;192.168.250.70&quot;</span> http_method=POST</pre>
                </div><a href=""><span class="image fit"><img src="images/53-5.png" alt="images/53-5.png" /></a>﻿The
                result in the <strong>src_ip</strong> field shows two IP addresses sending all the POST requests to our
                server.<strong><br /></strong><br /><br />The term Joomla is associated with the webserver found in a
                couple
                of
                fields like <strong>uri</strong>, <strong>uri_path</strong>, <strong>http_referrer</strong>, etc. This
                means
                our
                webserver is using Joomla CMS (Content Management Service) in the backend.<br />A little search on the
                internet
                for
                the admin login page of the Joomla CMS will show as
                -&gt; <strong>/joomla/administrator/index.php</strong><br />It
                is important because this uri contains the login page to access the web portal therefore we will be
                examining
                the
                traffic coming into this admin panel for a potential brute-force attack.<br /><br /><a
                  href="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e8dd9a4a45e18443162feab/room-content/ea62d4ec767a649904b5f5bba9ba1d62.png"><span
                    class="image fit"><img src="images/53-6.png" alt="images/53-6.png" /></a><strong>
                  Reference:
                  <a
                    href="https://www.joomla.org/administrator/index.php">https://www.joomla.org/administrator/index.php</a><br />We
                  can narrow down our search to see the requests sent to the login portal using this
                  information.<br /><br /><strong>
                    <h3>Search query: </h3>
                  </strong>
                  <div class="codebox">
                    <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 imreallynotbatman.com sourcetype=stream<span style="color:#ff9d00;font-weight:700">:</span>http dest_ip=<span style="color:#3ad900;font-weight:400">&quot;192.168.250.70&quot;</span><br> uri=<span style="color:#3ad900;font-weight:400">&quot;/joomla/administrator/index.php&quot;</span></pre>
                  </div><a href=""><span class="image fit"><img src="images/53-7.png"
                        alt="images/53-7.png" /></a><strong>form_data</strong> The field contains the
                  requests
                  sent
                  through
                  the form on the admin panel page, which has a login page. We suspect the attacker may have tried
                  multiple
                  credentials in an attempt to gain access to the admin panel. To confirm, we will dig deep into the
                  values
                  contained
                  within the form_data field, as shown below:<br /><strong>
                    <h3>Search Query: </h3>
                  </strong>
                  <div class="codebox">
                    <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 sourcetype=stream<span style="color:#ff9d00;font-weight:700">:</span>http dest_ip=<span style="color:#3ad900;font-weight:400">&quot;192.168.250.70&quot;</span> http_method=POST <br> uri=<span style="color:#3ad900;font-weight:400">&quot;/joomla/administrator/index.php&quot;</span> <span style="color:#ff9d00;font-weight:700">|</span> table _time uri src_ip dest_ip form_data</pre>
                  </div><a href=""><span class="image fit"><img src="images/53-8.png" alt="images/53-8.png" /></a>If we
                  keep
                  looking
                  at the results, we will find two interesting fields <strong>username</strong> that includes the single
                  username <strong>admin</strong> in all the events and another field <strong>passwd</strong> that
                  contains
                  multiple
                  passwords in it, which shows the attacker from the IP <strong>23.22.63.114</strong> Was trying to
                  guess
                  the
                  password
                  by brute-forcing and attempting numerous passwords.<br /><br />The time elapsed between multiple
                  events
                  also
                  suggests that the attacker was using an automated tool as various attempts were observed in a short
                  time.<br /><br /><br /><strong>
                    <h3>Extracting Username and Passwd Fields using Regex:</h3>
                  </strong><br />Looking into the logs, we see that these fields are not parsed properly. Let us
                  use <strong>Regex</strong> in the search to extract only these two fields and their values from the
                  logs
                  and
                  display
                  them.<br />We can display only the logs that contain
                  the <strong>username</strong> and <strong>passwd</strong> values in the form_data field by
                  adding <strong>form_data=*username*passwd*</strong> in the above search.<br /><br /><strong>
                    <h3>Search Query: </h3>
                  </strong>
                  <div class="codebox">
                    <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 sourcetype=stream<span style="color:#ff9d00;font-weight:700">:</span>http dest_ip=<span style="color:#3ad900;font-weight:400">&quot;192.168.250.70&quot;</span> http_method=POST <br> uri=<span style="color:#3ad900;font-weight:400">&quot;/joomla/administrator/index.php&quot;</span> form_data=*username*<span style="color:#ff9d00;font-weight:700">passwd</span>* <span style="color:#ff9d00;font-weight:700"><br>|</span> table _time uri src_ip dest_ip form_data</pre>
                  </div><a href=""><span class="image fit"><img src="images/53-9.png"
                        alt="images/53-9.png" /></a>It&#39;s time to use
                  Regex <strong>(regular expressions)</strong> to extract all the password values found against the
                  field
                  passwd
                  in
                  the logs. To do so, Splunk has a function called rex. If we type it in the search head, it will show
                  detail
                  and an
                  example of how to use it to extract the values.<br /><br /><a
                    href="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e8dd9a4a45e18443162feab/room-content/5ff9ecd4bf13a65356c0f6b9431d90c5.png"><span
                      class="image fit"><img src="images/53-10.png" alt="images/53-10.png" /></a><br /><br /><br />Now,
                  let&#39;s use Regex,
                  &quot;<strong>rex field=form_data “passwd=(?&lt;creds&gt;\w+)</strong>” to extract
                  the <strong>passwd</strong> values only. This will pick the <strong>form_data</strong> field and
                  extract
                  all
                  the
                  values found with the field.
                  <h3>Search Query:</h3>
                </strong>
                <div class="codebox">
                  <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 sourcetype=stream<span style="color:#ff9d00;font-weight:700">:</span>http dest_ip=<span style="color:#3ad900;font-weight:400">&quot;192.168.250.70&quot;</span> http_method=POST <br> form_data=*username*<span style="color:#ff9d00;font-weight:700">passwd</span>* <span style="color:#ff9d00;font-weight:700">|</span> rex field=form_data <span style="color:#3ad900;font-weight:400">&quot;passwd=(?&lt;creds&gt;\w+)&quot;</span> <span style="color:#ff9d00;font-weight:700"><br>|</span> table src_ip creds</pre>
                </div><br /><a href=""><span class="image fit"><img src="images/53-11.png"
                      alt="images/53-11.png" /></a>We have
                extracted
                the
                passwords being used against the username admin on the admin panel of the webserver. If we examine the
                fields
                in
                the
                logs, we will find two values against the field <strong>http_user_agent</strong> as shown
                below:<br /><br /><a href=""><span class="image fit"><img src="images/53-12.png"
                      alt="images/53-12.png" /></a>The
                first
                value clearly shows
                attacker used a python script to automate the brute force attack against our server. But one request
                came
                from
                a
                Mozilla browser. WHY? To find the answer to this query, let&#39;s slightly change to the about search
                query
                and
                add <strong>http_user_agent</strong> a field in the search head.<br />Let&#39;s create a table to
                display
                key
                fields
                and values by appending -&gt; <strong>| table _time src_ip uri http_user_agent creds</strong> in the
                search
                query
                as
                shown below.<br /><br /><strong>
                  <h3>Search Query: </h3>
                </strong>
                <div class="codebox">
                  <pre><span style="color:#7f0044;font-weight:400">index</span>=botsv1 sourcetype=stream<span style="color:#ff9d00;font-weight:700">:</span>http dest_ip=<span style="color:#3ad900;font-weight:400">&quot;192.168.250.70&quot;</span> http_method=POST <br> form_data=*username*<span style="color:#ff9d00;font-weight:700">passwd</span>* <span style="color:#ff9d00;font-weight:700">|</span> rex field=form_data <span style="color:#3ad900;font-weight:400">&quot;passwd=(?&lt;creds&gt;\w+)&quot;</span> <span style="color:#ff9d00;font-weight:700"><br>|</span>table _time src_ip uri http_user_agent creds</pre>
                </div><a href=""><span class="image fit"><img src="images/53-13.png" alt="images/53-13.png" /></a>This
                result
                clearly shows a continuous brute-force attack attempt from an IP <strong>23.22.63.114</strong> and 1
                password
                attempt <strong>batman</strong> from IP <strong>40.80.148.42</strong> using the Mozilla
                browser.<br /><br />It&#39;s
                worth noting that before attempting to brute-force access into our server, the attacker tried an
                <strong>SQL
                  Injection</strong> attack, but their efforts were unsuccessful due to our firewall blocking
                them.<br /><br /><strong>
                  <h3>Search Query: </h3>
                </strong>
                <div class="codebox">
                  <pre><span style="color:#7f0044;font-weight:400">index</span>=<span style="color:#3ad900;font-weight:400">&quot;botsv1&quot;</span> src=<span style="color:#3ad900;font-weight:400">&quot;40.80.148.42&quot;</span></pre>
                </div><a href=""><span class="image fit"><img src="images/53-14.png"
                      alt="images/53-14.png" /></a><strong>
                  <h3>Search Query: </h3>
                </strong>
                <div class="codebox">
                  <pre><span style="color:#7f0044;font-weight:400">index</span>=<span style="color:#3ad900;font-weight:400">&quot;botsv1&quot;</span> src=<span style="color:#3ad900;font-weight:400">&quot;40.80.148.42&quot;</span> signature=<span style="color:#3ad900;font-weight:400">&quot;HTTP.URI.SQL.Injection&quot;</span></pre>
                </div><a href=""><span class="image fit"><img src="images/53-15.png" alt="images/53-15.png" /></a>
                We looked into the traces of exploitation attempts and found brute-force attacks against our
                server,
                which
                were
                successful.<br /><strong>
                  <h3>Findings:</h3>
                </strong><br />• Brute force attack originated from IP <strong>23.22.63.114</strong>.<br />• The IP
                address
                used
                to
                gain access: <strong>40.80.148.42</strong><br />• 142 unique brute force attempts were made against
                the
                server,
                out
                of which one attempt was successful<br />
    </div>

    <body class="is-preload">
      <header id="header">
        <a href="https://yrtree.me/@Miguel%20Nogueira" class="logo">Connect with
          me</a>
      </header>
      <!-- Copyright -->
      <div id="copyright">
        <ul>
          <li>
            <h6><a href="index.html">Home Page</h6>
            </a>
          </li>
          <li>
            <h6><a href="CTFS.html">Previous ‎ ‎ ‎</h6>
            </a>
          </li>

        </ul>
      </div>

      <!-- Scripts -->
      <script src="assets/js/jquery.min.js"></script>
      <script src="assets/js/jquery.scrollex.min.js"></script>
      <script src="assets/js/jquery.scrolly.min.js"></script>
      <script src="assets/js/browser.min.js"></script>
      <script src="assets/js/breakpoints.min.js"></script>
      <script src="assets/js/util.js"></script>
      <script src="assets/js/main.js"></script>

    </body>

</html>